# El Gamal Fait (1/2)

## Challenge
On m'a dit qu'on pouvait utiliser RSA pour signer des messages au lieu de les chiffrer. J'ai essayé de faire pareil avec ElGamal. Est-ce que vous pouvez vérifier si ce que j'ai fait est sécurisé ?

## Inputs
- [el-gamal-fait-1.py](./el-gamal-fait-1.py)
- server at challenges.france-cybersecurity-challenge.fr:2151

## Analysis
This is a `ElGamal` cryptosystem, used for signing, without hash function:
```python
def generate(bits):
    p = getPrime(bits)
    x = randrange(p)
    g = randrange(2, p)
    y = pow(g,x,p)
    return p, g, x, y

def sign(p, g, x, m):
    k = randrange(p)
    r = pow(g, k, p)
    inv_k = pow(k, -1, p - 1)
    s = ((m - x * r) * inv_k) % (p - 1)
    return r, s

def verify(p, g, y, m, r, s):
    if r <= 0 or r >= p - 1 or s < 0 or s >= p - 1:
        return False
    return pow(g, m, p) == ((pow(y, r, p) * pow(r, s, p)) % p)
```

This is vulnerable to `forgery attack`, as explained here: https://core.ac.uk/download/pdf/48535618.pdf

We can also find a similar `CTF challenge` here: https://ctftime.org/writeup/30186

## Solution
Following the above mentionned paper, we can forge a solution by selecting integers B, C and compute:

```
r = g^B * y^C mod p
s = -rC      mod p-1
m = -rB/C    mod p-1
```

We can for instance choose `B=C=1`, and this gives us a message `m` with a valid signing pair `(r, s)`:
```
r = g*y mod p
s = -r  mod p-1
m = -r  mod p-1
```

We need to interact with the server using `pwntools`, fetch the values `p, g, y`, compute `r, s, m` as above:
```python
c = remote("challenges.france-cybersecurity-challenge.fr", 2151)
c.recvuntil(b"Public key:\n")

p_ = c.recvline().decode()
p = int(p_.split()[2])

g_ = c.recvline().decode()
g = int(g_.split()[2])

y_ = c.recvline().decode()
y = int(y_.split()[2])

r = g*y % p
s = (-r) % (p-1)
m = (-r) % (p-1)

c.recvuntil(b"Input a message.\n")
c.recvuntil(b">>> ")
c.sendline(str(m))
c.recvuntil(b"Input a signature. First, input r.\n")
c.recvuntil(b">>> ")
c.sendline(str(r))
c.recvuntil(b"Now, input s.\n")
c.recvuntil(b">>> ")
c.sendline(str(s))
c.recvline()
```

When verified by the server, the provided message `m` and signing pair `(r, s)` are validated and the flag is printed out:
```console
$ python3 sol.py DEBUG
[+] Opening connection to challenges.france-cybersecurity-challenge.fr on port 2151: Done
[DEBUG] Received 0xb bytes:
    b'Public key:'
[DEBUG] Received 0x1 bytes:
    b'\n'
[DEBUG] Received 0x26d bytes:
    b'p = 23152141957062903996088197978854222577273397312048637699282657965336309079643220457623702670535647582507628194555962671296927401664936365476085283473233743055069199202682746719795614038478542301122112161352181292743004434062746598467876800923743379700797973346320848772582405399687432038126068730399940685519741065306016554148993257643258505759930871839007626135703392993561287135669601555695701634924492451405182829870597922219323916029375982593608012809656201181393986341485252207401178861477327704317978933134613784133032770039478973637209031455867653071099478868449744752503234555932867365473126313106398557791497'
[DEBUG] Received 0x4f1 bytes:
    b'\n'
    b'g = 15473119824190317957833394966594322964721991311430877909003098071092458015711457915516081244680123599633199476100876048040175357935108238462446965433102520221793253968150538914580324786417527854671672097337686631288595160284464848122673150752037418429624659137552352903053105749681391363271705108284500455839379622868109583198108025493327661686459644793223392556765689578208287756050894500205424400307317324487847612357379209263287378874183700722344531814476089217585567328322913106308620610352961041883829332686698882549442571655397890030190649190035793025278078758506957229554287181420997689213856242747053099499256\n'
    b'y = 5083828177257348930467326387965970581847961359102569913142354178908085788631353612163266026512673225585429877843786810071669468732353810124072797036920156840685821012475628577998448474508126337909584873698995233348415897637730020500784686517592881528054117260459957731371765220597550120180481457275737850290937091380676838506889776221324664145439165289483263765890105249888063016093636686309566617228793404482366986385311718507380901554887516343799391175799465811750292760090016876032101561789587310885228976324864875042985554587913294914037591485965579730096107992471761062149054486925632181535143685827213984599134\n'
    b'Input a message.\n'
    b'>>> '
  c.sendline(str(m))
[DEBUG] Sent 0x26a bytes:
    b'13845678591536528956710653225439209063195643871452911000099287268049154367197882813476117117954166816998094520435284592780223696401736463577051040829460288305232404622896922901619998624754000579262898183014309632990163376429322969218272007194917526884343940859595272268684108242302715421374390520328027001780525906617170263878674996286104349633302451942571720329648703566621576592308288741553810530301937583907336149611083442829727147758163304864015422971754354484388013316231177059890423223159486967112797637577281352054543050626330722984234302402959343531356965977224575523535319485275130678662449358834387298655614\n'
[DEBUG] Received 0x27 bytes:
    b'Input a signature. First, input r.\n'
    b'>>> '
  c.sendline(str(r))
[DEBUG] Sent 0x269 bytes:
    b'9306463365526375039377544753415013514077753440595726699183370697287154712445337644147585552581480765509533674120678078516703705263199901899034242643773454749836794579785823818175615413724541721859213978337871659752841057633423629249604793728825852816454032486725576503898297157384716616751678210071913683739215158688846290270318261357154156126628419896435905806054689426939710543361312814141891104622554867497846680259514479389596768271212677729592589837901846697005973025254075147510755638317840737205181295557332432078489719413148250652974729052908309539742512891225169228967915070657736686810676954272011259135882\n'
[DEBUG] Received 0x12 bytes:
    b'Now, input s.\n'
    b'>>> '
  c.sendline(str(s))
[DEBUG] Sent 0x26a bytes:
    b'13845678591536528956710653225439209063195643871452911000099287268049154367197882813476117117954166816998094520435284592780223696401736463577051040829460288305232404622896922901619998624754000579262898183014309632990163376429322969218272007194917526884343940859595272268684108242302715421374390520328027001780525906617170263878674996286104349633302451942571720329648703566621576592308288741553810530301937583907336149611083442829727147758163304864015422971754354484388013316231177059890423223159486967112797637577281352054543050626330722984234302402959343531356965977224575523535319485275130678662449358834387298655614\n'
[DEBUG] Received 0x44 bytes:
    b'Congratulations! The message and signature match. Here is your flag:'
[DEBUG] Received 0x49 bytes:
    b'\n'
    b'FCSC{9494cb0e1aad8257099a1d1c146b740f01cd9573b26de3370bdd9d09aadcff54}\n'
    b'\n'
[*] Closed connection to challenges.france-cybersecurity-challenge.fr port 2151
```

## Flag
> FCSC{9494cb0e1aad8257099a1d1c146b740f01cd9573b26de3370bdd9d09aadcff54}
